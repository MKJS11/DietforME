<!--pages/recipe/detail.wxml-->
<view class="container">
  <!-- åŠ è½½ä¸­çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{isLoading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½èœè°±ä¿¡æ¯ä¸­...</text>
  </view>
  
  <!-- é£Ÿè°±ä¸å­˜åœ¨ -->
  <view class="error-container" wx:elif="{{!recipe}}">
    <text class="error-text">æœªæ‰¾åˆ°èœè°±ä¿¡æ¯</text>
    <view class="error-action" bindtap="goBack">è¿”å›</view>
  </view>
  
  <!-- é£Ÿè°±è¯¦æƒ… -->
  <block wx:else>
    <!-- é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ -->
    <view class="recipe-header">
      <view class="back-button" bindtap="goBack">
        <text class="back-icon">â†</text>
      </view>
      <view class="recipe-title-container">
        <text class="recipe-title">{{recipe.name}}</text>
        <view class="recipe-meta">
          <view class="meta-item">
            <text class="meta-icon">â±ï¸</text>
            <text class="meta-text">{{recipe.time}}</text>
          </view>
          <view class="meta-item">
            <text class="meta-icon">ğŸ”¥</text>
            <text class="meta-text">{{recipe.calories}}</text>
          </view>
          <view class="meta-item">
            <text class="meta-icon">ğŸ‘¥</text>
            <text class="meta-text">{{recipe.servings}}</text>
          </view>
          <view class="meta-item">
            <text class="meta-icon">â­</text>
            <text class="meta-text">{{recipe.difficulty}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- å†…å®¹åŒºåŸŸ -->
    <view class="recipe-content">
      <!-- åˆ†ç±»å’Œæ ‡ç­¾ -->
      <view class="tags-section" wx:if="{{recipe.categories.length > 0 || recipe.tags.length > 0}}">
        <view class="categories-container" wx:if="{{recipe.categories && recipe.categories.length > 0}}">
          <view wx:for="{{recipe.categories}}" wx:key="*this" class="category-item">
            {{item}}
          </view>
        </view>
        <view class="tags-container" wx:if="{{recipe.tags && recipe.tags.length > 0}}">
          <view wx:for="{{recipe.tags}}" wx:key="*this" class="tag-item">
            #{{item}}
          </view>
        </view>
      </view>
      
      <!-- è¯„åˆ†åŒºåŸŸ -->
      <view class="rating-section">
        <view class="rating-stars">
          <block wx:for="{{5}}" wx:key="*this">
            <text class="star {{index < recipe.rating ? 'filled' : ''}}">â­</text>
          </block>
        </view>
        <text class="rating-count">{{recipe.ratingCount}}æ¡è¯„ä»·</text>
      </view>
      
      <!-- å¥åº·ç›Šå¤„ -->
      <view class="section">
        <view class="section-header">
          <text class="section-title">å¥åº·ç›Šå¤„</text>
        </view>
        <view class="section-content">
          <text class="benefits-text">{{recipe.benefits || 'æš‚æ— å¥åº·ç›Šå¤„ä¿¡æ¯'}}</text>
        </view>
      </view>
      
      <!-- é£Ÿæåˆ—è¡¨ -->
      <view class="section">
        <view class="section-header" bindtap="toggleIngredients">
          <text class="section-title">é£Ÿææ¸…å•</text>
          <view class="section-actions">
            <view class="action-button" catchtap="addToShoppingList">
              <text class="action-icon">ğŸ›’</text>
              <text class="action-text">æ·»åŠ </text>
            </view>
            <text class="toggle-icon">{{showIngredients ? 'â–¼' : 'â–¶'}}</text>
          </view>
        </view>
        <view class="section-content {{!showIngredients ? 'hidden' : ''}}">
          <view class="ingredients-list" wx:if="{{recipe.ingredients && recipe.ingredients.length > 0}}">
            <view wx:for="{{recipe.ingredients}}" wx:key="index" class="ingredient-item">
              <text class="ingredient-icon">â€¢</text>
              <text class="ingredient-name">{{item.name || item}}</text>
              <text class="ingredient-amount" wx:if="{{item.amount}}">{{item.amount}}{{item.unit || ''}}</text>
            </view>
          </view>
          <text wx:else class="no-data">æš‚æ— é£Ÿæä¿¡æ¯</text>
        </view>
      </view>
      
      <!-- è¥å…»æˆåˆ† -->
      <view class="section">
        <view class="section-header" bindtap="toggleNutrition">
          <text class="section-title">è¥å…»æˆåˆ†</text>
          <text class="toggle-icon">{{showNutrition ? 'â–¼' : 'â–¶'}}</text>
        </view>
        <view class="section-content {{!showNutrition ? 'hidden' : ''}}">
          <view class="nutrition-grid">
            <block wx:if="{{recipe.nutritionArray && recipe.nutritionArray.length > 0}}">
              <view wx:for="{{recipe.nutritionArray}}" wx:key="index" class="nutrition-item">
                <text class="nutrition-name">{{item.name}}</text>
                <text class="nutrition-value">{{item.value}}</text>
              </view>
            </block>
            <block wx:else>
              <view class="nutrition-item">
                <text class="nutrition-name">è›‹ç™½è´¨</text>
                <text class="nutrition-value">0g</text>
              </view>
              <view class="nutrition-item">
                <text class="nutrition-name">è„‚è‚ª</text>
                <text class="nutrition-value">0g</text>
              </view>
              <view class="nutrition-item">
                <text class="nutrition-name">ç¢³æ°´åŒ–åˆç‰©</text>
                <text class="nutrition-value">0g</text>
              </view>
              <view class="nutrition-item">
                <text class="nutrition-name">è†³é£Ÿçº¤ç»´</text>
                <text class="nutrition-value">0g</text>
              </view>
            </block>
          </view>
        </view>
      </view>
      
      <!-- çƒ¹é¥ªæ­¥éª¤ -->
      <view class="section">
        <view class="section-header" bindtap="toggleSteps">
          <text class="section-title">çƒ¹é¥ªæ­¥éª¤</text>
          <text class="toggle-icon">{{showSteps ? 'â–¼' : 'â–¶'}}</text>
        </view>
        <view class="section-content {{!showSteps ? 'hidden' : ''}}">
          <view class="steps-list" wx:if="{{recipe.steps && recipe.steps.length > 0}}">
            <view wx:for="{{recipe.steps}}" wx:key="index" class="step-item">
              <view class="step-number">{{index + 1}}</view>
              <text class="step-text">{{item}}</text>
            </view>
          </view>
          <text wx:else class="no-data">æš‚æ— çƒ¹é¥ªæ­¥éª¤ä¿¡æ¯</text>
        </view>
      </view>
      
      <!-- çƒ¹é¥ªå°è´´å£« -->
      <view class="section" wx:if="{{recipe.tips && recipe.tips.length > 0}}">
        <view class="section-header" bindtap="toggleTips">
          <text class="section-title">çƒ¹é¥ªå°è´´å£«</text>
          <text class="toggle-icon">{{showTips ? 'â–¼' : 'â–¶'}}</text>
        </view>
        <view class="section-content {{!showTips ? 'hidden' : ''}}">
          <view class="tips-list">
            <view wx:for="{{recipe.tips}}" wx:key="index" class="tip-item">
              <text class="tip-icon">ğŸ’¡</text>
              <text class="tip-text">{{item}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- è¯„è®ºåŒºåŸŸ -->
      <view class="section" wx:if="{{recipe.comments && recipe.comments.length > 0}}">
        <view class="section-header" bindtap="toggleComments">
          <text class="section-title">ç”¨æˆ·è¯„ä»·</text>
          <text class="toggle-icon">{{showComments ? 'â–¼' : 'â–¶'}}</text>
        </view>
        <view class="section-content {{!showComments ? 'hidden' : ''}}">
          <view class="comments-list">
            <view wx:for="{{recipe.comments}}" wx:key="index" class="comment-item">
              <view class="comment-header">
                <view class="comment-avatar"></view>
                <view class="comment-info">
                  <text class="comment-username">{{item.userName || 'åŒ¿åç”¨æˆ·'}}</text>
                  <text class="comment-time">{{item.createdAt || ''}}</text>
                </view>
                <view class="comment-rating">
                  <block wx:if="{{item.rating > 0}}">
                    <text wx:for="{{[1, 2, 3, 4, 5]}}" wx:for-item="star" wx:for-index="starIndex" wx:key="*this" 
                          class="star {{starIndex < item.rating ? 'filled' : ''}}">â­</text>
                  </block>
                </view>
              </view>
              <text class="comment-content">{{item.content || ''}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- åº•éƒ¨æ“ä½œæ  -->
    <view class="action-bar">
      <view class="action-button" bindtap="toggleFavorite">
        <text class="action-icon {{isFavorite ? 'favorite' : ''}}">{{isFavorite ? 'â¤ï¸' : 'ğŸ¤'}}</text>
        <text class="action-text">{{isFavorite ? 'å·²æ”¶è—' : 'æ”¶è—'}}</text>
      </view>
      <view class="action-button" bindtap="showRatingModal">
        <text class="action-icon">â­</text>
        <text class="action-text">è¯„ä»·</text>
      </view>
      <button class="share-button" open-type="share">
        <text class="action-icon">ğŸ”—</text>
        <text class="action-text">åˆ†äº«</text>
      </button>
    </view>
    
    <!-- è¯„åˆ†æ¨¡æ€æ¡† -->
    <view class="rating-modal" wx:if="{{ratingModalVisible}}">
      <view class="rating-modal-content">
        <view class="rating-modal-title">è¯„ä»·èœè°±</view>
        <view class="rating-stars-input">
          <view wx:for="{{5}}" wx:key="index" class="rating-star {{index < userRating ? 'active' : ''}}" bindtap="setUserRating" data-rating="{{index + 1}}">
            â­
          </view>
        </view>
        <textarea class="comment-textarea" placeholder="åˆ†äº«æ‚¨çš„çƒ¹é¥ªä½“éªŒ..." bindinput="onCommentInput" value="{{commentContent}}"></textarea>
        <view class="rating-modal-actions">
          <view class="modal-button cancel" bindtap="closeRatingModal">å–æ¶ˆ</view>
          <view class="modal-button submit" bindtap="submitRating">æäº¤</view>
        </view>
      </view>
    </view>
  </block>
</view>